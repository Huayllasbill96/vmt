<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema VMT: Programa e Informes</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #198754;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #6c757d;
            --text-color: #212529;
            --white: #fff;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        /* --- ESTILOS GENERALES Y NAVEGACIÓN PRINCIPAL--- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: var(--text-color); margin: 0; padding: 10px; background-color: var(--light-gray); padding-top: 80px; }
        .container, .managers-container, .filters-container { max-width: 1200px; margin: 20px auto; border: 1px solid var(--medium-gray); padding: 25px; border-radius: 12px; background-color: var(--white); box-shadow: var(--shadow); }
        .nav-menu { text-align: center; margin: 0 auto 20px auto; max-width: 1200px; background-color: #fff; padding: 10px; border-radius: 12px; box-shadow: var(--shadow); display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; 
            position: fixed; top: 10px; left: 10px; right: 10px; z-index: 1000;
        }
        .nav-button { font-size: 1em; padding: 10px 20px; border: 1px solid var(--medium-gray); border-radius: 8px; cursor: pointer; background-color: var(--light-gray); font-weight: 600; transition: all 0.2s ease-in-out; }
        .nav-button:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.1); }
        .nav-button.active { background-color: var(--primary-color); color: var(--white); border-color: var(--primary-color); }
        
        /* --- ESTILOS PARA LA PESTAÑA 'PROGRAMA' --- */
        .week-selector-container { text-align: center; margin: 0 0 20px 0; padding: 15px; border-radius: 8px; background-color: var(--light-gray); border: 1px solid var(--medium-gray); }
        select.history-select { padding: 10px; font-size: 1em; border-radius: 8px; border: 1px solid var(--medium-gray); min-width: 300px; margin: 5px 0; max-width: 100%; }
        h1.program-title { text-align: left; border-bottom: none; padding-bottom: 0; margin-bottom: 15px; font-size: 1.5em; font-weight: 700; color: var(--primary-color); }
        .header-info, .intro-list { list-style: none; padding: 0; margin-bottom: 20px; }
        .header-info li, .intro-list li { padding: 4px 0; }
        .header-info strong { display: inline-block; width: 150px; }
        .header-info select { border: none; border-bottom: 1px dashed var(--dark-gray); background-color: transparent; font-family: inherit; font-size: inherit; padding: 4px; min-width: 200px; appearance: none; border-radius: 0; }
        .header-info select:focus { outline: none; background-color: #e6f2ff; border-bottom: 1px solid var(--primary-color); }
        table.main-program-table { width: 100%; border-collapse: collapse; margin-top: 20px; border: none; table-layout: fixed; }
        .main-program-table th, .main-program-table td { border: 1px solid var(--medium-gray); padding: 12px; text-align: left; vertical-align: top; word-wrap: break-word; }
        .main-program-table th { background-color: var(--light-gray); font-weight: 700; text-align: center; }
        .main-program-table thead th:first-child { background-color: #fff; border: none; }
        .header-time { font-size: .8em; font-weight: 400; color: var(--dark-gray); }
        .section-header { font-weight: 700; color: #fff; padding-left: 10px !important; font-size: 1.1em; }
        .tesoros-header { background-color: #5a6369; }
        .maestros-header { background-color: #c19a26; }
        .vida-cristiana-header { background-color: #8b2c39; }
        .participante { font-size: .9em; text-align: center; vertical-align: middle; }
        .participante select { width: 100%; border: none; background-color: transparent; padding: 4px; font-family: inherit; font-size: inherit; color: inherit; box-sizing: border-box; text-align: center; appearance: none; border-bottom: 1px dashed transparent; }
        .participante select:focus { outline: none; background-color: #e6f2ff; border-bottom: 1px solid var(--primary-color); border-radius: 4px; }
        .participant-pair { display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.2; gap: 4px; }
        
        /* --- ESTILOS GENERALES (Botones, Sub-navegación, Formularios) --- */
        .button { font-size: 1.1em; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; transition: all .2s; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .button:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .sub-nav-menu { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--light-gray); }
        .sub-nav-button { padding: 8px 12px; border: 1px solid var(--medium-gray); background-color: var(--light-gray); cursor: pointer; border-radius: 8px; font-size: .9em; font-weight: 500; }
        .sub-nav-button.active { background-color: var(--dark-gray); color: #fff; border-color: var(--dark-gray); }
        .list { list-style: none; padding: 0; }
        .list li { display: flex; justify-content: space-between; align-items: center; padding: 12px 8px; border-bottom: 1px solid var(--medium-gray); }
        .list .actions button { margin-left: 10px; padding: 5px 10px; cursor: pointer; border: 1px solid var(--medium-gray); border-radius: 4px; }
        .add-form { display: flex; gap: 10px; margin-bottom: 20px; }
        .add-form input { flex-grow: 1; padding: 10px; border: 1px solid var(--medium-gray); border-radius: 8px; }

        /* --- ESTILOS PARA LA PESTAÑA 'FILTROS' --- */
        .filters-container h2 { margin-top: 0; color: var(--primary-color); }
        .filter-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--medium-gray); }
        .filter-btn { padding: 8px 15px; border: 1px solid var(--medium-gray); background-color: var(--light-gray); cursor: pointer; border-radius: 20px; font-size: .9em; }
        .filter-btn.active { background-color: var(--primary-color); color: #fff; border-color: var(--primary-color); font-weight: 700; }
        .table-wrapper { max-height: 70vh; overflow: auto; }
        .filters-table { width: 100%; border-collapse: collapse; font-size: .9em; }
        .filters-table th, .filters-table td { border: 1px solid var(--medium-gray); padding: 8px; text-align: center; min-width: 60px; }
        .filters-table th { background-color: var(--light-gray); position: sticky; top: 0; z-index: 2; }
        .filters-table td:first-child, .filters-table th:first-child { text-align: left; font-weight: 700; position: sticky; left: 0; background-color: #fdfdfd; z-index: 1; min-width: 150px; }
        .filters-table th:first-child { z-index: 3; }
        .filters-legend { padding: 10px 15px; border: 1px solid var(--medium-gray); background-color: var(--light-gray); border-radius: 5px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; }
        .assignment-marker { display: inline-block; padding: 3px 8px; border-radius: 4px; font-weight: 700; font-size: .9em; line-height: 1.2; border: 1px solid rgba(0,0,0,.1); }
        .sala-main { background-color: #cfe2ff; color: #052c65; }
        .sala-aux2 { background-color: #d1e7dd; color: #0a3622; }
        .sala-aux3 { background-color: #fff3cd; color: #664d03; }

        /* --- ESTILOS PARA LA PESTAÑA 'INFORMES' (S-89) --- */
        .reports-filters { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; padding: 15px; background-color: var(--light-gray); border-radius: 8px; margin-bottom: 25px; }
        .reports-filters select { padding: 10px; border-radius: 8px; border: 1px solid var(--medium-gray); width: 100%; box-sizing: border-box; }
        #reports-container button { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; transition: all .2s; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1); width: 100%; box-sizing: border-box;}
        #reports-container button:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        #download-reports-btn { background-color: var(--secondary-color); color: #fff; margin-left: auto; }
        #reports-output { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .report-slip { position: relative; background-color: #fff; border: 1px solid var(--medium-gray); border-radius: 12px; padding: 20px; box-sizing: border-box; page-break-inside: avoid; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .report-field { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; font-size: .9em; }
        .report-field strong { position: relative; width: 90px; flex-shrink: 0; color: var(--dark-gray); }
        .report-field span { flex-grow: 1; border-bottom: 1px dotted #333; padding: 0 5px; font-weight: 500; }
        .delivery-check { flex-shrink: 0; margin-left: 10px; width: 22px; height: 22px; border: 2px solid #a0b0c8; border-radius: 50%; cursor: pointer; transition: all .3s; display: flex; align-items: center; justify-content: center; font-weight: 700; color: transparent; background-color: #f0f0f0;}
        .delivery-check.checked { background-color: var(--secondary-color); border-color: var(--secondary-color); color: #fff; }
        .report-slip h3 { text-align: center; margin-top: 0; margin-bottom: 25px; font-size: 1.1em; line-height: 1.3; color: var(--primary-color); }
        .report-slip .rooms { margin-top: 20px; font-size: .9em; }
        .report-slip .rooms div { margin-bottom: 5px; }
        .report-slip .footer-note { margin-top: 20px; font-size: .75em; color: var(--dark-gray); border-top: 1px solid var(--medium-gray); padding-top: 10px; }
        .room-label::before { content: '☐'; font-family: "DejaVu Sans", sans-serif; margin-right: 8px; font-size: 1.2em; vertical-align: middle; color: #555; }
        .room-label[data-checked="true"]::before { content: '☑'; }
        
        /* --- ESTILOS RESPONSIVOS PARA MÓVILES --- */
        @media (max-width: 768px) {
            body { padding: 10px; padding-top: 140px; padding-bottom: 40px; }
            .nav-menu { top: 5px; left: 5px; right: 5px; }
            .container, .managers-container, .filters-container { padding: 15px; }
            .nav-button { padding: 8px 12px; font-size: 0.85em; }
            
            .main-program-table thead, .filters-table thead { display: none; }
            .main-program-table, .main-program-table tbody, .main-program-table tr, .main-program-table td,
            .filters-table, .filters-table tbody, .filters-table tr, .filters-table td { display: block; width: 100%; box-sizing: border-box; }
            .main-program-table tr, .filters-table tr { border: 1px solid var(--medium-gray); margin-bottom: 15px; border-radius: 8px; padding: 10px; }
            .main-program-table td, .filters-table td { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border: none; border-bottom: 1px dotted var(--medium-gray); text-align: right; }
            .main-program-table td:last-child, .filters-table td:last-child { border-bottom: none; }
            .main-program-table td:before, .filters-table td:before { content: attr(data-label); font-weight: bold; text-align: left; padding-right: 10px; color: var(--dark-gray); }
            .main-program-table td:first-child, .filters-table td:first-child { display: block; background-color: var(--light-gray); font-weight: bold; text-align: center; padding: 10px; margin: -10px -10px 10px -10px; border-bottom: 1px solid var(--medium-gray); border-radius: 8px 8px 0 0; }
            .main-program-table td:first-child:before, .filters-table td:first-child:before { display: none; }
            .main-program-table td.section-header { margin: 15px -10px 10px -10px; color: white; border-radius: 4px; justify-content: center;}
            .participante { width: 60%; }
            .table-wrapper { max-height: none; overflow: visible; }
            .filters-legend { flex-direction: column; align-items: flex-start; }

            .add-form { flex-direction: column; }
            .add-form input, .add-form button { width: 100%; box-sizing: border-box; }
            .list li { flex-direction: column; align-items: flex-start; gap: 10px; }
            .list .actions { width: 100%; display: flex; justify-content: flex-end; }
            
            #reports-output { grid-template-columns: 1fr; }
            .reports-filters { flex-direction: column; align-items: flex-start; gap: 10px; }
            .reports-filters label { margin-bottom: 0; }
            #download-reports-btn { margin-left: 0; margin-top: 10px; }
        }
    </style>
</head>
<body>
    <div class="nav-menu">
        <button id="nav-program" class="nav-button active">Programa</button>
        <button id="nav-managers" class="nav-button">Gestionar Participantes</button>
        <button id="nav-filters" class="nav-button">Filtros Avanzados</button>
        <button id="nav-reports" class="nav-button">Informes</button>
    </div>

    <div id="program-container" class="container"></div>
    <div id="managers-container" class="managers-container" style="display: none;"></div>
    <div id="filters-container" class="filters-container" style="display: none;"></div>
    <div id="reports-container" class="container" style="display: none;"></div>

    <script>
    const SUPABASE_URL = 'https://iosdslhikguqyhspbpbn.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlvc2RzbGhpa2d1cXloc3BicGJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwOTMzNjMsImV4cCI6MjA2ODY2OTM2M30.HbgX9g1e4kYZf1jn0-8RR8BctYZctVopigZgZVXBaJY';
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    document.addEventListener('DOMContentLoaded', function() {
        let fullDataCache = {}, selectDataCache = {}, assignmentsByRole = {}, deliveryStatus = {}, reportsInitialized = false;
        const managerConfig = [ { type: 'presidentes', title: 'Presidentes', tableName: 'lista_encargados', singular: 'Presidente', placeholder: 'presidente' }, { type: 'consejeros', title: 'Consejeros', tableName: 'consejeros', singular: 'Consejero', placeholder: 'consejero' }, { type: 'oradores', title: 'Oración', tableName: 'oradores', singular: 'Orador', placeholder: 'orador' }, { type: 'discursantes', title: 'Discursantes (Tesoros/VMT)', tableName: 'discursantes', singular: 'Discursante', placeholder: 'discursante' }, { type: 'lectores', title: 'Lectores de Biblia', tableName: 'lectores', singular: 'Lector', placeholder: 'lector' }, { type: 'lectores_libro', title: 'Lectores de Libro', tableName: 'lectores_libro', singular: 'Lector', placeholder: 'lector de libro' }, { type: 'publicadores', title: 'Publicadores', tableName: 'publicadores', singular: 'Publicador', placeholder: 'publicador' }, { type: 'maestros_discurso', title: 'Discurso (Maestros)', tableName: 'maestros_discurso', singular: 'Discursante', placeholder: 'discursante' } ];
        
        async function initializeApp() {
            buildInitialHTML();
            setupNavigation();
            setupSubNavigation();
            setupProgramListeners();
            managerConfig.forEach(m => setupManager(m.type, m.tableName, m.singular));
            await loadAllSelects();
            await fetchAndDisplayHistory();
        }

        function buildInitialHTML() {
            document.getElementById('program-container').innerHTML = `<div class="week-selector-container"><label for="history-selector"><b>Seleccione la semana guardada en la nube</b></label><br><select id="history-selector" class="history-select"><option value="">-- Cargando... --</option></select></div><h1 id="week-title" class="program-title"></h1><ul id="header-info-list" class="header-info"></ul><ul id="intro-list-container" class="intro-list"></ul><table class="main-program-table"><thead><tr><th></th><th>Sala Auxiliar N°3 <br><span class="header-time">(7:00 p. m.)</span></th><th>Sala Auxiliar N°2</th><th>Auditorio principal</th></tr></thead><tbody id="main-program-body"></tbody></table><div class="button-container"><button id="save-button" class="button" style="background-color:#007bff;color:#fff;">Guardar Cambios</button></div><div id="status-message"></div>`;
            let managerHTML = '<div class="sub-nav-menu">';
            let panelHTML = '';
            managerConfig.forEach((m, index) => { managerHTML += `<button class="sub-nav-button ${index === 0 ? 'active' : ''}" data-manager="${m.type}">${m.title}</button>`; panelHTML += `<div id="${m.type}-manager-panel" class="manager-panel" style="display: ${index === 0 ? 'block' : 'none'};"><h2>Gestionar ${m.title}</h2><div class="add-form"><input type="text" id="new-${m.type}-name" placeholder="Nombre del nuevo ${m.placeholder}"><button id="add-${m.type}-button" class="button" style="background-color: #28a745; color: white;">Agregar</button></div><ul id="${m.type}-list" class="list"></ul><div id="status-message-${m.type}" style="text-align:center;margin-top:15px;font-weight:700;height:20px"></div></div>`; });
            document.getElementById('managers-container').innerHTML = managerHTML + '</div>' + panelHTML;
            document.getElementById('filters-container').innerHTML = `<h2>Filtros Avanzados</h2><p>Seleccione un tipo de asignación para ver un resumen.</p><div id="filter-buttons-container" class="filter-buttons"><p>Cargando filtros...</p></div><div id="filters-legend" class="filters-legend" style="display: none;"><h4>Leyenda:</h4><div class="legend-item"><span class="assignment-marker sala-main">Aud</span><span>Auditorio</span></div><div class="legend-item"><span class="assignment-marker sala-aux2">S2</span><span>Sala 2</span></div><div class="legend-item"><span class="assignment-marker sala-aux3">S3</span><span>Sala 3</span></div><div class="legend-item"><strong>E</strong><span>Encargado</span></div><div class="legend-item"><strong>A</strong><span>Ayudante</span></div></div><div id="filters-results" class="table-wrapper"><p>Seleccione un filtro.</p></div>`;
            document.getElementById('reports-container').innerHTML = `<h2>Generador de Hojas de Asignación (S-89)</h2><div class="reports-filters"><label for="report-week-filter"><strong>Filtrar por semana:</strong></label><select id="report-week-filter"><option value="">-- Todas --</option></select><label for="report-person-filter"><strong>Filtrar por persona:</strong></label><select id="report-person-filter"><option value="">-- Todas --</option></select><button id="clear-reports-filter-btn" style="background-color: #6c757d; color: white;">Limpiar</button><button id="download-reports-btn">Imprimir / Guardar PDF</button></div><div id="reports-output"><p>Cargando informes...</p></div>`;
        }
        
        function setupNavigation() { const navButtons = document.querySelectorAll('.nav-button'); const containers = { 'nav-program': document.getElementById('program-container'), 'nav-managers': document.getElementById('managers-container'), 'nav-filters': document.getElementById('filters-container'), 'nav-reports': document.getElementById('reports-container') }; navButtons.forEach(button => { button.addEventListener('click', () => { navButtons.forEach(btn => btn.classList.remove('active')); Object.values(containers).forEach(cont => cont.style.display = 'none'); button.classList.add('active'); containers[button.id].style.display = 'block'; if (butt
