<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema VMT: Programa e Informes</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #198754;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #6c757d;
            --text-color: #212529;
            --white: #fff;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        /* --- ESTILOS GENERALES Y NAVEGACIÓN PRINCIPAL--- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: var(--text-color); margin: 0; padding: 10px; background-color: var(--light-gray); padding-top: 80px; }
        .container, .managers-container, .filters-container { max-width: 1200px; margin: 20px auto; border: 1px solid var(--medium-gray); padding: 25px; border-radius: 12px; background-color: var(--white); box-shadow: var(--shadow); }
        .nav-menu { text-align: center; margin: 0 auto 20px auto; max-width: 1200px; background-color: #fff; padding: 10px; border-radius: 12px; box-shadow: var(--shadow); display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; 
            position: fixed; top: 10px; left: 10px; right: 10px; z-index: 1000;
        }
        .nav-button { font-size: 1em; padding: 10px 20px; border: 1px solid var(--medium-gray); border-radius: 8px; cursor: pointer; background-color: var(--light-gray); font-weight: 600; transition: all 0.2s ease-in-out; }
        .nav-button:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.1); }
        .nav-button.active { background-color: var(--primary-color); color: var(--white); border-color: var(--primary-color); }
        
        /* --- ESTILOS PARA LA PESTAÑA 'PROGRAMA' --- */
        .week-selector-container { text-align: center; margin: 0 0 20px 0; padding: 15px; border-radius: 8px; background-color: var(--light-gray); border: 1px solid var(--medium-gray); }
        select.history-select { padding: 10px; font-size: 1em; border-radius: 8px; border: 1px solid var(--medium-gray); min-width: 300px; margin: 5px 0; max-width: 100%; }
        h1.program-title { text-align: left; border-bottom: none; padding-bottom: 0; margin-bottom: 15px; font-size: 1.5em; font-weight: 700; color: var(--primary-color); }
        .header-info, .intro-list { list-style: none; padding: 0; margin-bottom: 20px; }
        .header-info li, .intro-list li { padding: 4px 0; }
        .header-info strong { display: inline-block; width: 150px; }
        .header-info select { border: none; border-bottom: 1px dashed var(--dark-gray); background-color: transparent; font-family: inherit; font-size: inherit; padding: 4px; min-width: 200px; appearance: none; border-radius: 0; }
        .header-info select:focus { outline: none; background-color: #e6f2ff; border-bottom: 1px solid var(--primary-color); }
        table.main-program-table { width: 100%; border-collapse: collapse; margin-top: 20px; border: none; table-layout: fixed; }
        .main-program-table th, .main-program-table td { border: 1px solid var(--medium-gray); padding: 12px; text-align: left; vertical-align: top; word-wrap: break-word; }
        .main-program-table th { background-color: var(--light-gray); font-weight: 700; text-align: center; }
        .main-program-table thead th:first-child { background-color: #fff; border: none; }
        .header-time { font-size: .8em; font-weight: 400; color: var(--dark-gray); }
        .section-header { font-weight: 700; color: #fff; padding-left: 10px !important; font-size: 1.1em; }
        .tesoros-header { background-color: #5a6369; }
        .maestros-header { background-color: #c19a26; }
        .vida-cristiana-header { background-color: #8b2c39; }
        .participante { font-size: .9em; text-align: center; vertical-align: middle; }
        .participante select { width: 100%; border: none; background-color: transparent; padding: 4px; font-family: inherit; font-size: inherit; color: inherit; box-sizing: border-box; text-align: center; appearance: none; border-bottom: 1px dashed transparent; }
        .participante select:focus { outline: none; background-color: #e6f2ff; border-bottom: 1px solid var(--primary-color); border-radius: 4px; }
        .participant-pair { display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.2; gap: 4px; }
        
        /* --- ESTILOS GENERALES (Botones, Sub-navegación, Formularios) --- */
        .button { font-size: 1.1em; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; transition: all .2s; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .button:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .sub-nav-menu { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--light-gray); }
        .sub-nav-button { padding: 8px 12px; border: 1px solid var(--medium-gray); background-color: var(--light-gray); cursor: pointer; border-radius: 8px; font-size: .9em; font-weight: 500; }
        .sub-nav-button.active { background-color: var(--dark-gray); color: #fff; border-color: var(--dark-gray); }
        .list { list-style: none; padding: 0; }
        .list li { display: flex; justify-content: space-between; align-items: center; padding: 12px 8px; border-bottom: 1px solid var(--medium-gray); }
        .list .actions button { margin-left: 10px; padding: 5px 10px; cursor: pointer; border: 1px solid var(--medium-gray); border-radius: 4px; }
        .add-form { display: flex; gap: 10px; margin-bottom: 20px; }
        .add-form input { flex-grow: 1; padding: 10px; border: 1px solid var(--medium-gray); border-radius: 8px; }

        /* --- ESTILOS PARA LA PESTAÑA 'FILTROS' --- */
        .filters-container h2 { margin-top: 0; color: var(--primary-color); }
        .filter-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--medium-gray); }
        .filter-btn { padding: 8px 15px; border: 1px solid var(--medium-gray); background-color: var(--light-gray); cursor: pointer; border-radius: 20px; font-size: .9em; }
        .filter-btn.active { background-color: var(--primary-color); color: #fff; border-color: var(--primary-color); font-weight: 700; }
        .table-wrapper { max-height: 70vh; overflow: auto; }
        .filters-table { width: 100%; border-collapse: collapse; font-size: .9em; }
        .filters-table th, .filters-table td { border: 1px solid var(--medium-gray); padding: 8px; text-align: center; min-width: 60px; }
        .filters-table th { background-color: var(--light-gray); position: sticky; top: 0; z-index: 2; }
        .filters-table td:first-child, .filters-table th:first-child { text-align: left; font-weight: 700; position: sticky; left: 0; background-color: #fdfdfd; z-index: 1; min-width: 150px; }
        .filters-table th:first-child { z-index: 3; }
        .filters-legend { padding: 10px 15px; border: 1px solid var(--medium-gray); background-color: var(--light-gray); border-radius: 5px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; }
        .assignment-marker { display: inline-block; padding: 3px 8px; border-radius: 4px; font-weight: 700; font-size: .9em; line-height: 1.2; border: 1px solid rgba(0,0,0,.1); }
        .sala-main { background-color: #cfe2ff; color: #052c65; }
        .sala-aux2 { background-color: #d1e7dd; color: #0a3622; }
        .sala-aux3 { background-color: #fff3cd; color: #664d03; }

        /* --- ESTILOS PARA LA PESTAÑA 'INFORMES' (S-89) --- */
        .reports-filters { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; padding: 15px; background-color: var(--light-gray); border-radius: 8px; margin-bottom: 25px; }
        .reports-filters select { padding: 10px; border-radius: 8px; border: 1px solid var(--medium-gray); width: 100%; box-sizing: border-box; }
        #reports-container button { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; transition: all .2s; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1); width: 100%; box-sizing: border-box;}
        #reports-container button:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        #download-reports-btn { background-color: var(--secondary-color); color: #fff; margin-left: auto; }
        #reports-output { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .report-slip { position: relative; background-color: #fff; border: 1px solid var(--medium-gray); border-radius: 12px; padding: 20px; box-sizing: border-box; page-break-inside: avoid; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .report-field { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; font-size: .9em; }
        .report-field strong { position: relative; width: 90px; flex-shrink: 0; color: var(--dark-gray); }
        .report-field span { flex-grow: 1; border-bottom: 1px dotted #333; padding: 0 5px; font-weight: 500; }
        .delivery-check { flex-shrink: 0; margin-left: 10px; width: 22px; height: 22px; border: 2px solid #a0b0c8; border-radius: 50%; cursor: pointer; transition: all .3s; display: flex; align-items: center; justify-content: center; font-weight: 700; color: transparent; background-color: #f0f0f0;}
        .delivery-check.checked { background-color: var(--secondary-color); border-color: var(--secondary-color); color: #fff; }
        .report-slip h3 { text-align: center; margin-top: 0; margin-bottom: 25px; font-size: 1.1em; line-height: 1.3; color: var(--primary-color); }
        .report-slip .rooms { margin-top: 20px; font-size: .9em; }
        .report-slip .rooms div { margin-bottom: 5px; }
        .report-slip .footer-note { margin-top: 20px; font-size: .75em; color: var(--dark-gray); border-top: 1px solid var(--medium-gray); padding-top: 10px; }
        .room-label::before { content: '☐'; font-family: "DejaVu Sans", sans-serif; margin-right: 8px; font-size: 1.2em; vertical-align: middle; color: #555; }
        .room-label[data-checked="true"]::before { content: '☑'; }
        
        /* --- ESTILOS RESPONSIVOS PARA MÓVILES --- */
        @media (max-width: 768px) {
            body { padding: 10px; padding-top: 140px; padding-bottom: 40px; }
            .nav-menu { top: 5px; left: 5px; right: 5px; }
            .container, .managers-container, .filters-container { padding: 15px; }
            .nav-button { padding: 8px 12px; font-size: 0.85em; }
            
            .main-program-table thead, .filters-table thead { display: none; }
            .main-program-table, .main-program-table tbody, .main-program-table tr, .main-program-table td,
            .filters-table, .filters-table tbody, .filters-table tr, .filters-table td { display: block; width: 100%; box-sizing: border-box; }
            .main-program-table tr, .filters-table tr { border: 1px solid var(--medium-gray); margin-bottom: 15px; border-radius: 8px; padding: 10px; }
            .main-program-table td, .filters-table td { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border: none; border-bottom: 1px dotted var(--medium-gray); text-align: right; }
            .main-program-table td:last-child, .filters-table td:last-child { border-bottom: none; }
            .main-program-table td:before, .filters-table td:before { content: attr(data-label); font-weight: bold; text-align: left; padding-right: 10px; color: var(--dark-gray); }
            .main-program-table td:first-child, .filters-table td:first-child { display: block; background-color: var(--light-gray); font-weight: bold; text-align: center; padding: 10px; margin: -10px -10px 10px -10px; border-bottom: 1px solid var(--medium-gray); border-radius: 8px 8px 0 0; }
            .main-program-table td:first-child:before, .filters-table td:first-child:before { display: none; }
            .main-program-table td.section-header { margin: 15px -10px 10px -10px; color: white; border-radius: 4px; justify-content: center;}
            /* ... otros estilos de móvil ... */

.main-program-table td.section-header { 
    margin: 15px -10px 10px -10px; 
    color: white; 
    border-radius: 4px; 
    justify-content: center;
}
/* --- AQUÍ EL CÓDIGO NUEVO Y CORREGIDO --- */
.main-program-table td.tesoros-header {
  background-color: #5a6369;
}
.main-program-table td.maestros-header {
  background-color: #c19a26;
}
.main-program-table td.vida-cristiana-header {
  background-color: #8b2c39;
}
/* -------------------------------------- */
/* ------------------------------------ */
/* ... código anterior ... */

/* -------------------------------------- */


/* --- PEGA AQUÍ EL NUEVO CÓDIGO PARA OCULTAR SALAS VACÍAS --- */
.main-program-table tr td:not(.participante):not(:first-child) {
    display: none;
}
/* ----------------------------------------------------------- */


.participante { width: 60%; }

/* ... el resto de los estilos de móvil ... */
            .participante { width: 60%; }
            .table-wrapper { max-height: none; overflow: visible; }
            .filters-legend { flex-direction: column; align-items: flex-start; }

            .add-form { flex-direction: column; }
            .add-form input, .add-form button { width: 100%; box-sizing: border-box; }
            .list li { flex-direction: column; align-items: flex-start; gap: 10px; }
            .list .actions { width: 100%; display: flex; justify-content: flex-end; }
            
            #reports-output { grid-template-columns: 1fr; }
            .reports-filters { flex-direction: column; align-items: flex-start; gap: 10px; }
            .reports-filters label { margin-bottom: 0; }
            #download-reports-btn { margin-left: 0; margin-top: 10px; }
        }
    </style>
</head>
<body>
    <div class="nav-menu">
        <button id="nav-program" class="nav-button active">Programa</button>
        <button id="nav-managers" class="nav-button">Gestionar Participantes</button>
        <button id="nav-filters" class="nav-button">Filtros Avanzados</button>
        <button id="nav-reports" class="nav-button">Informes</button>
    </div>

    <div id="program-container" class="container"></div>
    <div id="managers-container" class="managers-container" style="display: none;"></div>
    <div id="filters-container" class="filters-container" style="display: none;"></div>
    <div id="reports-container" class="container" style="display: none;"></div>

    <script>
    const SUPABASE_URL = 'https://iosdslhikguqyhspbpbn.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlvc2RzbGhpa2d1cXloc3BicGJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwOTMzNjMsImV4cCI6MjA2ODY2OTM2M30.HbgX9g1e4kYZf1jn0-8RR8BctYZctVopigZgZVXBaJY';
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    document.addEventListener('DOMContentLoaded', function() {
        let fullDataCache = {}, selectDataCache = {}, assignmentsByRole = {}, deliveryStatus = {}, reportsInitialized = false;
        const managerConfig = [ { type: 'presidentes', title: 'Presidentes', tableName: 'lista_encargados', singular: 'Presidente', placeholder: 'presidente' }, { type: 'consejeros', title: 'Consejeros', tableName: 'consejeros', singular: 'Consejero', placeholder: 'consejero' }, { type: 'oradores', title: 'Oración', tableName: 'oradores', singular: 'Orador', placeholder: 'orador' }, { type: 'discursantes', title: 'Discursantes (Tesoros/VMT)', tableName: 'discursantes', singular: 'Discursante', placeholder: 'discursante' }, { type: 'lectores', title: 'Lectores de Biblia', tableName: 'lectores', singular: 'Lector', placeholder: 'lector' }, { type: 'lectores_libro', title: 'Lectores de Libro', tableName: 'lectores_libro', singular: 'Lector', placeholder: 'lector de libro' }, { type: 'publicadores', title: 'Publicadores', tableName: 'publicadores', singular: 'Publicador', placeholder: 'publicador' }, { type: 'maestros_discurso', title: 'Discurso (Maestros)', tableName: 'maestros_discurso', singular: 'Discursante', placeholder: 'discursante' } ];
        
        async function initializeApp() {
            buildInitialHTML();
            setupNavigation();
            setupSubNavigation();
            setupProgramListeners();
            managerConfig.forEach(m => setupManager(m.type, m.tableName, m.singular));
            await loadAllSelects();
            await fetchAndDisplayHistory();
        }

        function buildInitialHTML() {
            document.getElementById('program-container').innerHTML = `<div class="week-selector-container"><label for="history-selector"><b>Seleccione la semana guardada en la nube</b></label><br><select id="history-selector" class="history-select"><option value="">-- Cargando... --</option></select></div><h1 id="week-title" class="program-title"></h1><ul id="header-info-list" class="header-info"></ul><ul id="intro-list-container" class="intro-list"></ul><table class="main-program-table"><thead><tr><th></th><th>Sala Auxiliar N°3 <br><span class="header-time">(7:00 p. m.)</span></th><th>Sala Auxiliar N°2</th><th>Auditorio principal</th></tr></thead><tbody id="main-program-body"></tbody></table><div class="button-container"><button id="save-button" class="button" style="background-color:#007bff;color:#fff;">Guardar Cambios</button></div><div id="status-message"></div>`;
            let managerHTML = '<div class="sub-nav-menu">';
            let panelHTML = '';
            managerConfig.forEach((m, index) => { managerHTML += `<button class="sub-nav-button ${index === 0 ? 'active' : ''}" data-manager="${m.type}">${m.title}</button>`; panelHTML += `<div id="${m.type}-manager-panel" class="manager-panel" style="display: ${index === 0 ? 'block' : 'none'};"><h2>Gestionar ${m.title}</h2><div class="add-form"><input type="text" id="new-${m.type}-name" placeholder="Nombre del nuevo ${m.placeholder}"><button id="add-${m.type}-button" class="button" style="background-color: #28a745; color: white;">Agregar</button></div><ul id="${m.type}-list" class="list"></ul><div id="status-message-${m.type}" style="text-align:center;margin-top:15px;font-weight:700;height:20px"></div></div>`; });
            document.getElementById('managers-container').innerHTML = managerHTML + '</div>' + panelHTML;
            document.getElementById('filters-container').innerHTML = `<h2>Filtros Avanzados</h2><p>Seleccione un tipo de asignación para ver un resumen.</p><div id="filter-buttons-container" class="filter-buttons"><p>Cargando filtros...</p></div><div id="filters-legend" class="filters-legend" style="display: none;"><h4>Leyenda:</h4><div class="legend-item"><span class="assignment-marker sala-main">Aud</span><span>Auditorio</span></div><div class="legend-item"><span class="assignment-marker sala-aux2">S2</span><span>Sala 2</span></div><div class="legend-item"><span class="assignment-marker sala-aux3">S3</span><span>Sala 3</span></div><div class="legend-item"><strong>E</strong><span>Encargado</span></div><div class="legend-item"><strong>A</strong><span>Ayudante</span></div></div><div id="filters-results" class="table-wrapper"><p>Seleccione un filtro.</p></div>`;
            document.getElementById('reports-container').innerHTML = `<h2>Generador de Hojas de Asignación (S-89)</h2><div class="reports-filters"><label for="report-week-filter"><strong>Filtrar por semana:</strong></label><select id="report-week-filter"><option value="">-- Todas --</option></select><label for="report-person-filter"><strong>Filtrar por persona:</strong></label><select id="report-person-filter"><option value="">-- Todas --</option></select><button id="clear-reports-filter-btn" style="background-color: #6c757d; color: white;">Limpiar</button><button id="download-reports-btn">Imprimir / Guardar PDF</button></div><div id="reports-output"><p>Cargando informes...</p></div>`;
        }
        
        function setupNavigation() { const navButtons = document.querySelectorAll('.nav-button'); const containers = { 'nav-program': document.getElementById('program-container'), 'nav-managers': document.getElementById('managers-container'), 'nav-filters': document.getElementById('filters-container'), 'nav-reports': document.getElementById('reports-container') }; navButtons.forEach(button => { button.addEventListener('click', () => { navButtons.forEach(btn => btn.classList.remove('active')); Object.values(containers).forEach(cont => cont.style.display = 'none'); button.classList.add('active'); containers[button.id].style.display = 'block'; if (button.id === 'nav-managers' && document.getElementById(`${managerConfig[0].type}-list`).innerHTML === '') loadManagerData(managerConfig[0].type, managerConfig[0].tableName, managerConfig[0].singular); else if (button.id === 'nav-filters') setupAdvancedFilters(); else if (button.id === 'nav-reports' && !reportsInitialized) { setupReportsTab(); reportsInitialized = true; } }); }); document.getElementById('program-container').style.display = 'block'; }
        function setupSubNavigation(){document.querySelector(".sub-nav-menu").addEventListener("click",e=>{if(e.target.matches(".sub-nav-button")){const t=e.target.dataset.manager;document.querySelectorAll(".sub-nav-button").forEach(e=>e.classList.remove("active")),e.target.classList.add("active"),document.querySelectorAll(".manager-panel").forEach(e=>e.style.display="none"),document.getElementById(`${t}-manager-panel`).style.display="block";const a=managerConfig.find(e=>e.type===t);a&&loadManagerData(a.type,a.tableName,a.singular)}})}
        function setupProgramListeners(){document.getElementById("history-selector").addEventListener("change",e=>loadWeekData(e.target.value)),document.getElementById("save-button").addEventListener("click",saveCurrentDataToCloud)}
        function setupManager(e,t,a){const n=document.getElementById(`add-${e}-button`),o=document.getElementById(`new-${e}-name`),s=document.getElementById(`status-message-${e}`);n.addEventListener("click",async()=>{const n=o.value.trim();if(!n)return void alert("Por favor, ingrese un nombre.");s.textContent="Agregando...";(await db.from(t).insert({nombre:n})).error?(s.textContent="Error al agregar."):(o.value="",await loadManagerData(e,t,a),await loadAllSelects())}),document.getElementById(`${e}-list`).addEventListener("click",async n=>{const o=n.target.closest("button");if(o){const n=o.dataset.id,r=o.dataset.name;if(o.classList.contains("edit-btn")){const i=prompt("Editar nombre:",r);i&&i.trim()&&i.trim()!==r&&(s.textContent="Actualizando...",await db.from(t).update({nombre:i.trim()}).eq("id",n),await loadManagerData(e,t,a),await loadAllSelects())}o.classList.contains("delete-btn")&&confirm(`¿Seguro que desea eliminar a "${r}"?`)&&(s.textContent="Eliminando...",await db.from(t).delete().eq("id",n),await loadManagerData(e,t,a),await loadAllSelects())}})}
        async function loadManagerData(e,t,a){const n=document.getElementById(`status-message-${e}`);n.textContent="Cargando...";const{data:o,error:s}=await db.from(t).select("id, nombre").order("nombre",{ascending:!0});if(s)return void(n.textContent="Error al cargar.");const r=document.getElementById(`${e}-list`);r.innerHTML=0===o.length?`<li>No hay ${a.toLowerCase()}s registrados.</li>`:o.map(e=>`<li><span>${e.nombre}</span><div class="actions"><button class="edit-btn" data-id="${e.id}" data-name="${e.nombre}">Editar</button><button class="delete-btn" data-id="${e.id}" data-name="${e.nombre}">Eliminar</button></div></li>`).join(""),n.textContent=""}
        async function loadAllSelects(){for(const e of managerConfig){const{data:t}=await db.from(e.tableName).select("nombre").order("nombre");t&&(selectDataCache[e.type]=t)}}
        function getOptionsHTML(e,t){let a='<option value="">-- No asignado --</option>';return e&&(a+=e.map(e=>`<option value="${e.nombre}"${e.nombre===t?" selected":""}>${e.nombre}</option>`).join("")),a}
        async function fetchAndDisplayHistory(){const e=document.getElementById("status-message");e.textContent="Cargando historial...";const{data:t,error:a}=await db.from("programas").select("week_id, data").order("week_id",{ascending:!0});if(a||!t)return void(e.textContent="Error al cargar historial.");fullDataCache={};const n=document.getElementById("history-selector");n.innerHTML=t.map(e=>(fullDataCache[e.week_id]=e.data,`<option value="${e.week_id}">${e.data.titulo||e.week_id}</option>`)).join(""),t.length>0?(n.value=n.options[n.options.length-1].value,loadWeekData(n.value)):e.textContent="No hay programas en la nube."}
        function loadWeekData(e){const t=fullDataCache[e];t&&populateForm(t)}
        function populateForm(e){const t=["Sala Auxiliar N°3","Sala Auxiliar N°2","Auditorio principal"];document.getElementById("week-title").textContent=e.titulo||"",document.getElementById("header-info-list").innerHTML=`<li><strong>Presidente:</strong> <select id="presidente">${getOptionsHTML(selectDataCache.presidentes,e.presidentes?.principal)}</select></li><li><strong>Sala auxiliar N° 2:</strong> <select id="auxiliar-2">${getOptionsHTML(selectDataCache.consejeros,e.presidentes?.aux2)}</select></li><li><strong>Sala auxiliar N° 3:</strong> <select id="auxiliar-3">${getOptionsHTML(selectDataCache.consejeros,e.presidentes?.aux3)}</select></li><li><strong>Oración de Inicio:</strong> <select id="oracion-inicio">${getOptionsHTML(selectDataCache.oradores,e.oracion?.inicio)}</select></li>`,document.getElementById("intro-list-container").innerHTML=`<li>• ${e.canciones?.inicio||""}</li><li>• Palabras de introducción (1 min.)</li>`;const a=document.getElementById("main-program-body");let s=`<tr><td colspan="4" class="section-header tesoros-header">TESOROS DE LA BIBLIA</td></tr><tr><td>${e.tesoros?.p1?.title||""}</td><td data-label="${t[0]}"></td><td data-label="${t[1]}"></td><td class="participante" data-label="${t[2]}"><select id="tesoros-p1-main">${getOptionsHTML(selectDataCache.discursantes,e.tesoros?.p1?.main)}</select></td></tr><tr><td>${e.tesoros?.p2?.title||""}</td><td data-label="${t[0]}"></td><td data-label="${t[1]}"></td><td class="participante" data-label="${t[2]}"><select id="tesoros-p2-main">${getOptionsHTML(selectDataCache.discursantes,e.tesoros?.p2?.main)}</select></td></tr><tr><td>${e.tesoros?.p3?.title||""}</td><td class="participante" data-label="${t[0]}"><select id="tesoros-p3-aux3">${getOptionsHTML(selectDataCache.lectores,e.tesoros?.p3?.aux3)}</select></td><td class="participante" data-label="${t[1]}"><select id="tesoros-p3-aux2">${getOptionsHTML(selectDataCache.lectores,e.tesoros?.p3?.aux2)}</select></td><td class="participante" data-label="${t[2]}"><select id="tesoros-p3-main">${getOptionsHTML(selectDataCache.lectores,e.tesoros?.p3?.main)}</select></td></tr><tr><td colspan="4" class="section-header maestros-header">SEAMOS MEJORES MAESTROS</td></tr>`;(e.maestros||[]).forEach((e,a)=>{const o=e.title.toLowerCase().includes("discurso");s+=`<tr><td>${e.title||""}</td>`,["aux3","aux2","main"].forEach((l,c)=>{const d=(e[l]||"").split("/").map(e=>e.trim()),n=d[0]||"",r=d[1]||"";s+=`<td class="participante" data-label="${t[c]}">${o?`<select data-part-index="${a}" data-room="${l}">${getOptionsHTML(selectDataCache.maestros_discurso,n)}</select>`:`<div class="participant-pair"><div><select data-part-index="${a}" data-room="${l}" data-person="1">${getOptionsHTML(selectDataCache.publicadores,n)}</select><span class="separator"> /</span></div><select data-part-index="${a}" data-room="${l}" data-person="2">${getOptionsHTML(selectDataCache.publicadores,r)}</select></div>`}</td>`}),s+="</tr>"}),s+='<tr><td colspan="4" class="section-header vida-cristiana-header">NUESTRA VIDA CRISTIANA</td></tr>',e.canciones?.vidaCristiana&&(s+=`<tr><td>• <b>${e.canciones.vidaCristiana}</b></td><td data-label="${t[0]}"></td><td data-label="${t[1]}"></td><td data-label="${t[2]}"></td></tr>`),(e.vidaCristiana||[]).forEach((e,a)=>{let o="";e.hasOwnProperty("conductor")?o=`<strong>Conductor:</strong> <select class="vc-conductor" data-vc-index="${a}">${getOptionsHTML(selectDataCache.discursantes,e.conductor)}</select><br><strong>Lector:</strong> <select class="vc-lector" data-vc-index="${a}">${getOptionsHTML(selectDataCache.lectores_libro,e.lector)}</select>`:e.hasOwnProperty("discursante")&&(o=`<select class="vc-discursante" data-vc-index="${a}">${getOptionsHTML(selectDataCache.discursantes,e.discursante)}</select>`),s+=`<tr><td>• ${e.numero||""}. ${e.titulo||""}</td><td data-label="${t[0]}"></td><td data-label="${t[1]}"></td><td class="participante" data-label="${t[2]}">${o}</td></tr>`}),s+=`<tr><td>• Palabras de conclusión (3 mins.)</td><td data-label="${t[0]}"></td><td data-label="${t[1]}"></td><td data-label="${t[2]}"></td></tr><tr><td>• <b>${e.canciones?.final||""}</b></td><td data-label="${t[0]}"></td><td data-label="${t[1]}"></td><td data-label="${t[2]}"></td></tr><tr><td><strong>Oración Final:</strong></td><td data-label="${t[0]}"></td><td data-label="${t[1]}"></td><td class="participante" data-label="${t[2]}"><select id="oracion-final">${getOptionsHTML(selectDataCache.oradores,e.oracion?.final)}</select></td></tr>`,a.innerHTML=s,document.getElementById("status-message").textContent=""}
        function getCurrentFormData(){const e=document.getElementById("history-selector").value,t=JSON.parse(JSON.stringify(fullDataCache[e]));return t?(t.presidentes={principal:document.getElementById("presidente").value,aux2:document.getElementById("auxiliar-2").value,aux3:document.getElementById("auxiliar-3").value},t.oracion={inicio:document.getElementById("oracion-inicio").value,final:document.getElementById("oracion-final").value},t.tesoros.p1.main=document.getElementById("tesoros-p1-main").value,t.tesoros.p2.main=document.getElementById("tesoros-p2-main").value,t.tesoros.p3={main:document.getElementById("tesoros-p3-main").value,aux2:document.getElementById("tesoros-p3-aux2").value,aux3:document.getElementById("tesoros-p3-aux3").value},t.maestros.forEach((e,a)=>{["aux2","aux3","main"].forEach(s=>{if(e.title.toLowerCase().includes("discurso"))e[s]=document.querySelector(`select[data-part-index="${a}"][data-room="${s}"]`)?.value||"";else{const o=document.querySelector(`select[data-part-index="${a}"][data-room="${s}"][data-person="1"]`),t=document.querySelector(`select[data-part-index="${a}"][data-room="${s}"][data-person="2"]`);e[s]=[o?.value,t?.value].filter(Boolean).join(" / ")}})}),t.vidaCristiana.forEach((e,a)=>{e.hasOwnProperty("conductor")?(e.conductor=document.querySelector(`.vc-conductor[data-vc-index="${a}"]`)?.value||"",e.lector=document.querySelector(`.vc-lector[data-vc-index="${a}"]`)?.value||""):e.hasOwnProperty("discursante")&&(e.discursante=document.querySelector(`.vc-discursante[data-vc-index="${a}"]`)?.value||"")}),t):null}
        async function saveCurrentDataToCloud(){const e=document.getElementById("history-selector").value;if(!e)return void alert("Seleccione una semana para guardar.");const t=document.getElementById("status-message");t.textContent="Guardando en la nube...";const a=getCurrentFormData();if(!a)return void(t.textContent="Error al recopilar los datos.");const{error:s}=await db.from("programas").update({data:a}).eq("week_id",e);t.textContent=s?`Error al guardar: ${s.message}`:"¡Guardado en la nube con éxito!",s||(fullDataCache[e]=a)}
        function addAssignment(e,t,a,s,l){if(!a||!a.trim())return;const o=a.split("/").map(e=>e.trim()).filter(Boolean);o.forEach((a,c)=>{let d=o.length>1?(0===c?"E":"A"):null;e[t]||(e[t]={}),e[t][a]||(e[t][a]=[]),e[t][a].some(e=>e.date===s&&e.room===l)||e[t][a].push({date:s,room:l,subRole:d})})}
        function collectAllAssignments(){const e={};for(const t in fullDataCache){const a=fullDataCache[t];a&&(addAssignment(e,"Presidente",a.presidentes?.principal,t,"main"),addAssignment(e,"Consejero",a.presidentes?.aux2,t,"aux2"),addAssignment(e,"Consejero",a.presidentes?.aux3,t,"aux3"),addAssignment(e,"Oración Inicio",a.oracion?.inicio,t,"main"),addAssignment(e,"Oración Final",a.oracion?.final,t,"main"),addAssignment(e,"Discurso (Tesoros)",a.tesoros?.p1?.main,t,"main"),addAssignment(e,"Discurso (Tesoros)",a.tesoros?.p2?.main,t,"main"),addAssignment(e,"Lectura de la Biblia",a.tesoros?.p3?.main,t,"main"),addAssignment(e,"Lectura de la Biblia",a.tesoros?.p3?.aux2,t,"aux2"),addAssignment(e,"Lectura de la Biblia",a.tesoros?.p3?.aux3,t,"aux3"),(a.maestros||[]).forEach(a=>{const s=a.title.toLowerCase().includes("discurso")?"Discurso (Maestros)":"Demostración (Maestros)";addAssignment(e,s,a.main,t,"main"),addAssignment(e,s,a.aux2,t,"aux2"),addAssignment(e,s,a.aux3,t,"aux3")}),(a.vidaCristiana||[]).forEach(a=>{a.hasOwnProperty("conductor")&&(addAssignment(e,"Conducción del Libro",a.conductor,t,"main"),addAssignment(e,"Lector del Libro",a.lector,t,"main")),a.hasOwnProperty("discursante")&&addAssignment(e,"Discurso (Vida Cristiana)",a.discursante,t,"main")}))}return e}
        function setupAdvancedFilters(){assignmentsByRole=collectAllAssignments();const e=document.getElementById("filter-buttons-container"),t=Object.keys(assignmentsByRole).sort(),a=[...new Set(Object.values(assignmentsByRole).flat().flatMap(Object.values).flat().map(a=>a.date))].sort();document.getElementById("filters-legend").style.display="none",document.getElementById("filters-results").innerHTML='<p>Seleccione un filtro para ver los resultados.</p>',e.innerHTML=0<t.length?t.map(e=>`<button class="filter-btn" data-role="${e}">${e}</button>`).join(""): "<p>No hay datos de asignaciones para mostrar.</p>",e.addEventListener("click",e=>{e.target.matches(".filter-btn")&&(document.querySelectorAll(".filter-btn").forEach(e=>e.classList.remove("active")),e.target.classList.add("active"),displayFilteredTable(e.target.dataset.role,a))})}
        function displayFilteredTable(e,t){const a=document.getElementById("filters-results"),s=document.getElementById("filters-legend"),l=assignmentsByRole[e];if(!l)return a.innerHTML=`<p>No hay asignaciones para el rol "${e}".</p>`,void(s.style.display="none");s.style.display="flex";const o=Object.keys(l).sort();let c='<table class="filters-table"><thead><tr><th>Participante</th>';t.forEach(e=>{c+=`<th>${e.substring(5).replace("-","/")}</th>`}),c+="</tr></thead><tbody>";const d={main:"Aud",aux2:"S2",aux3:"S3"};o.forEach(e=>{c+=`<tr><td data-label="Participante">${e}</td>`;const a=l[e];t.forEach(t=>{const s=a.find(e=>e.date===t);c+=`<td data-label="${t.substring(5).replace("-","/")}">${s?`<span class="assignment-marker sala-${s.room}">${s.subRole||d[s.room]||"X"}</span>`:"-"}</td>`}),c+="</tr>"}),c+="</tbody></table>",a.innerHTML=c}

        function setupReportsTab() { document.getElementById('download-reports-btn').addEventListener('click', prepareAndPrint); document.getElementById('report-week-filter').addEventListener('change', generateReportSlips); document.getElementById('report-person-filter').addEventListener('change', generateReportSlips); document.getElementById('clear-reports-filter-btn').addEventListener('click', () => { document.getElementById('report-week-filter').value = ""; document.getElementById('report-person-filter').value = ""; generateReportSlips(); }); document.getElementById('reports-output').addEventListener('click', e => { if (e.target.matches('.delivery-check')) { const t = e.target, a = t.closest('.report-slip').dataset.slipId, s = t.dataset.person; deliveryStatus[a] && (deliveryStatus[a][s] = !deliveryStatus[a][s], t.classList.toggle('checked', deliveryStatus[a][s])) } }); setupReportSlipFilters(); generateReportSlips(); }
        function prepareAndPrint() { let e = ""; const t = document.querySelectorAll("#reports-output .report-slip"); for (let a = 0; a < t.length; a += 8) { let s = '<div class="print-page">'; const l = Array.from(t).slice(a, a + 8); l.forEach(t => { s += t.outerHTML }), s += "</div>", e += s } const a = ` @page { size: A4 landscape; margin: 0; } body { margin: 0; font-family: Arial, sans-serif; } .print-page { display: flex; flex-wrap: wrap; justify-content: space-around; align-content: space-around; height: 100vh; box-sizing: border-box; page-break-after: always; } .report-slip { border: 1px solid #000; background-color: #fff; color: #000; font-size: 8.5pt; padding: 8px; overflow: hidden; display: flex; flex-direction: column; box-sizing: border-box; width: calc(25% - 8px); height: calc(50% - 8px); position: relative; } .report-field { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; font-size:.9em; } .report-field strong { position: relative; width:90px; flex-shrink:0; } .report-field span { flex-grow:1; border-bottom:1px dotted #000; padding:0 3px; } .report-slip h3 { text-align:center; margin-top:0; margin-bottom:20px; font-size:1em; line-height:1.2; } .report-slip .rooms { margin-top:15px; font-size:.9em; } .report-slip .rooms div { margin-bottom:5px; } .report-slip .footer-note { margin-top:auto; font-size:.7em; color:#555; border-top:1px solid #ddd; padding-top:8px; } .room-label::before { content: '☐'; font-family: "DejaVu Sans", sans-serif; margin-right: 8px; font-size: 1.2em; vertical-align: middle; } .room-label[data-checked="true"]::before { content: '☑'; } .delivery-check { flex-shrink:0; margin-left:10px; width:22px; height:22px; border:2px solid #a0b0c8; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:transparent; } .delivery-check.checked { background-color:#28a745; border-color:#28a745; color:#fff; } .delivery-check:not(.checked) { display: none; } .delivery-check.checked { display: flex !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; background-color: #28a745 !important; border-color: #28a745 !important; color: #fff !important; border-radius: 50% !important; } `, s = window.open("", "", "height=800,width=1200"); s.document.write(`<html><head><title>Imprimir Asignaciones</title><style>${a}</style></head><body>${e}</body></html>`), s.document.close(), setTimeout(() => { s.focus(), s.print(), s.close() }, 250) }
        function setupReportSlipFilters() { const e = document.getElementById("report-week-filter"), t = document.getElementById("report-person-filter"); e.innerHTML = '<option value="">-- Todas las semanas --</option>', Object.keys(fullDataCache).sort().forEach(t => { e.innerHTML += `<option value="${t}">${fullDataCache[t].titulo||t}</option>` }); const a = new Set; Object.values(fullDataCache).forEach(e => { (e.maestros || []).forEach(e => { ["main", "aux2", "aux3"].forEach(t => { e[t] && e[t].split("/").forEach(e => a.add(e.trim())) }) }) }), t.innerHTML = '<option value="">-- Todas las personas --</option>', Array.from(a).sort().forEach(e => { e && (t.innerHTML += `<option value="${e}">${e}</option>`) }) }
        function generateReportSlips() { const e = document.getElementById("reports-output"), t = document.getElementById("report-week-filter").value, a = document.getElementById("report-person-filter").value; let s = []; deliveryStatus = {}; const l = t ? [t] : Object.keys(fullDataCache); l.forEach(e => { const t = fullDataCache[e]; if(!t) return; (t.maestros || []).forEach(l => { ["main", "aux2", "aux3"].forEach(o => { if (l[o]) { const c = l[o].split("/").map(e => e.trim()).filter(Boolean), [d, n] = c; d && (s.push({ ...{ participant: d, helper: n || "", weekId: t.week_id, weekTitle: t.titulo, partTitle: l.title, room: o }, intendedFor: "participant" }), n && s.push({ ...{ participant: d, helper: n || "", weekId: t.week_id, weekTitle: t.titulo, partTitle: l.title, room: o }, intendedFor: "helper" })) } }) }) }); const o = a ? s.filter(e => e.participant === a || e.helper === a) : s; e.innerHTML = 0 < o.length ? o.map((e, t) => createReportSlipHTML(e, t)).join("") : "<p>No se encontraron asignaciones con los filtros seleccionados.</p>" }
        function createReportSlipHTML(e, t) { const a = `slip-${e.weekId}-${e.participant.replace(/\s+/g,"")}-${e.helper.replace(/\s+/g,"")}-${t}`; deliveryStatus[a] = { participant: "participant" === e.intendedFor, helper: "helper" === e.intendedFor && !!e.helper }; const s = getFridayOfMeetingWeek(e.weekTitle, e.weekId), l = deliveryStatus[a].participant ? "checked" : "", o = deliveryStatus[a].helper ? "checked" : "", c = `<div class="report-field"><strong>Nombre:</strong> <span>${e.participant}</span><div class="delivery-check ${l}" data-person="participant" title="Entregado a ${e.participant}">✓</div></div>`, d = e.helper ? `<div class="report-field"><strong>Ayudante:</strong> <span>${e.helper}</span><div class="delivery-check ${o}" data-person="helper" title="Entregado a ${e.helper}">✓</div></div>` : '<div class="report-field"><strong>Ayudante:</strong> <span>Ninguno</span></div>', n = `<div class="rooms"><strong>Se presentará en:</strong><div><span class="room-label" data-checked="${"main"===e.room}"> Sala principal</span></div><div><span class="room-label" data-checked="${"aux2"===e.room}"> Sala auxiliar núm. 2</span></div><div><span class="room-label" data-checked="${"aux3"===e.room}"> Sala auxiliar núm. 3</span></div></div>`; return `<div class="report-slip" data-slip-id="${a}" data-room="${e.room}"><h3>ASIGNACIÓN PARA LA REUNIÓN<br>VIDA Y MINISTERIO CRISTIANOS</h3>${c}${d}<div class="report-field"><strong>Fecha:</strong> <span>${s}</span></div><div class="report-field"><strong>Intervención:</strong> <span>${e.partTitle}</span></div>${n}<div class="footer-note"><strong>Nota:</strong> En la <em>Guía de actividades</em> encontrará la información para su intervención. Repase las <em>Instrucciones para la reunión</em> (S-38).<div style="text-align: right; margin-top: 5px;">S-89-S 11/23</div></div></div>` }
        function getFridayOfMeetingWeek(e, t) { const a = { ENERO: 0, FEBRERO: 1, MARZO: 2, ABRIL: 3, MAYO: 4, JUNIO: 5, JULIO: 6, AGOSTO: 7, SEPTIEMBRE: 8, OCTUBRE: 9, NOVIEMBRE: 10, DICIEMBRE: 11 }; try { const s = parseInt(t.substring(0, 4)), l = e.match(/(\d{1,2}) DE (\w+)/i); if (!l) return e; const o = parseInt(l[1]), c = l[2].toUpperCase(), d = a[c]; if (void 0 === d) return e; let n = new Date(Date.UTC(s, d, o)); let r = n.getUTCDay(); let i = 5 - r; 0 > i && (i += 7); let u = new Date(n); return u.setUTCDate(n.getUTCDate() + i), new Intl.DateTimeFormat("es-ES", { day: "numeric", month: "long", year: "numeric" }).format(u) } catch (s) { return e } }
        
        initializeApp();
    });
    </script>
</body>
</html>
